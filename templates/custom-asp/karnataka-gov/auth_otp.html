<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karnataka Government - eSign Authentication</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <style>
        body {
            background-color: #f5f5f5;
            font-family: 'Arial', sans-serif;
        }
        .header-section {
            background-color: #FF9933;
            padding: 10px 0;
            text-align: center;
        }
        .header-section h3 {
            color: white;
            margin: 0;
            font-size: 24px;
        }
        .sub-header {
            background-color: #138808;
            padding: 5px 0;
            text-align: center;
        }
        .sub-header p {
            color: white;
            margin: 0;
            font-size: 14px;
        }
        .logo-section {
            background-color: white;
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .logo-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .govt-logo {
            height: 60px;
        }
        .main-container {
            max-width: 900px;
            margin: 30px auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .section-header {
            background: linear-gradient(90deg, #FF9933 0%, #138808 100%);
            color: white;
            padding: 15px 25px;
            font-size: 20px;
            font-weight: 500;
            border-radius: 8px 8px 0 0;
        }
        .content-section {
            padding: 30px;
        }
        .language-selector {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .consent-section {
            background-color: #fffdf0;
            border: 2px solid #FF9933;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .consent-section h5 {
            color: #138808;
            margin-bottom: 15px;
        }
        .consent-list {
            counter-reset: item;
            padding-left: 0;
        }
        .consent-list li {
            counter-increment: item;
            margin-bottom: 10px;
            padding-left: 30px;
            position: relative;
            list-style: none;
        }
        .consent-list li:before {
            content: counter(item) ".";
            position: absolute;
            left: 0;
            font-weight: bold;
            color: #FF9933;
        }
        .audio-consent {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        .btn-gov-primary {
            background-color: #FF9933;
            color: white;
            padding: 10px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-gov-primary:hover {
            background-color: #e68a2e;
        }
        .btn-gov-secondary {
            background-color: white;
            color: #138808;
            padding: 10px 30px;
            border: 2px solid #138808;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-gov-secondary:hover {
            background-color: #138808;
            color: white;
        }
        .input-group-gov {
            margin-bottom: 20px;
        }
        .input-group-gov label {
            color: #138808;
            font-weight: 500;
            margin-bottom: 5px;
            display: block;
        }
        .input-group-gov input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .input-group-gov input:focus {
            outline: none;
            border-color: #FF9933;
        }
        .info-box {
            background-color: #fff3e0;
            border-left: 4px solid #FF9933;
            padding: 15px;
            margin-bottom: 20px;
        }
        .otp-timer {
            font-size: 24px;
            font-weight: bold;
            color: #FF9933;
            text-align: center;
            margin: 20px 0;
        }
        #google_translate_element {
            display: inline-block;
        }
        .goog-te-banner-frame {
            display: none !important;
        }
        body {
            top: 0 !important;
        }
        .flag-icon {
            width: 20px;
            height: 15px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="header-section">
        <h3>ಕರ್ನಾಟಕ ಸರ್ಕಾರ | Government of Karnataka</h3>
    </div>
    <div class="sub-header">
        <p>ಡಿಜಿಟಲ್ ಸಹಿ ಸೇವೆ | Digital Signature Service</p>
    </div>

    <div class="logo-section">
        <div class="logo-container">
            <img src="/static/images/karnataka-emblem.png" alt="Karnataka Emblem" class="govt-logo">
            <img src="/static/images/digital-india.png" alt="Digital India" class="govt-logo">
        </div>
    </div>

    <div class="main-container">
        <div class="section-header">
            Aadhaar Based eSign Authentication | ಆಧಾರ್ ಆಧಾರಿತ ಇಸೈನ್ ದೃಢೀಕರಣ
        </div>
        
        <div class="content-section">
            <!-- Language Selector -->
            <div class="language-selector">
                <div>
                    <strong>Select Language / ಭಾಷೆ ಆಯ್ಕೆ:</strong>
                </div>
                <div id="google_translate_element"></div>
            </div>

            <!-- Transaction Information -->
            <div class="info-box">
                <h6 class="mb-2">Transaction Details | ವಹಿವಾಟು ವಿವರಗಳು</h6>
                <p class="mb-1"><strong>Department:</strong> {{.ASPName}}</p>
                <p class="mb-1"><strong>Transaction ID:</strong> {{.TransactionID}}</p>
                <p class="mb-0"><strong>Date & Time:</strong> {{.Timestamp}}</p>
            </div>

            <!-- Consent Section -->
            <div class="consent-section">
                <h5>Consent for Aadhaar Authentication | ಆಧಾರ್ ದೃಢೀಕರಣಕ್ಕೆ ಸಮ್ಮತಿ</h5>
                <ol class="consent-list">
                    <li>I hereby provide my consent to use my Aadhaar details for authentication through UIDAI authentication system for the purpose of digital signature.</li>
                    <li>ನಾನು ಡಿಜಿಟಲ್ ಸಹಿಯ ಉದ್ದೇಶಕ್ಕಾಗಿ UIDAI ದೃಢೀಕರಣ ವ್ಯವಸ್ಥೆಯ ಮೂಲಕ ದೃಢೀಕರಣಕ್ಕಾಗಿ ನನ್ನ ಆಧಾರ್ ವಿವರಗಳನ್ನು ಬಳಸಲು ನನ್ನ ಸಮ್ಮತಿಯನ್ನು ನೀಡುತ್ತೇನೆ.</li>
                    <li>I understand that my identity information will be used only for validating my identity through Aadhaar authentication system.</li>
                    <li>ನನ್ನ ಗುರುತಿನ ಮಾಹಿತಿಯನ್ನು ಆಧಾರ್ ದೃಢೀಕರಣ ವ್ಯವಸ್ಥೆಯ ಮೂಲಕ ನನ್ನ ಗುರುತನ್ನು ಮೌಲ್ಯೀಕರಿಸಲು ಮಾತ್ರ ಬಳಸಲಾಗುತ್ತದೆ ಎಂದು ನಾನು ಅರ್ಥಮಾಡಿಕೊಂಡಿದ್ದೇನೆ.</li>
                </ol>
                
                <!-- Audio Consent -->
                <div class="audio-consent">
                    <h6>Audio Consent | ಆಡಿಯೋ ಸಮ್ಮತಿ</h6>
                    <div class="audio-controls">
                        <button class="btn btn-sm btn-success" onclick="playConsent('kn')">
                            ಕನ್ನಡ
                        </button>
                        <button class="btn btn-sm btn-success" onclick="playConsent('en')">
                            English
                        </button>
                        <button class="btn btn-sm btn-success" onclick="playConsent('hi')">
                            हिन्दी
                        </button>
                        <audio id="consentAudio" controls style="display: none;"></audio>
                    </div>
                </div>

                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="consentCheck">
                    <label class="form-check-label" for="consentCheck">
                        <strong>I agree to the above terms | ನಾನು ಮೇಲಿನ ನಿಯಮಗಳನ್ನು ಒಪ್ಪುತ್ತೇನೆ</strong>
                    </label>
                </div>
            </div>

            <!-- Aadhaar Input Section -->
            <div id="aadhaarSection">
                <div class="input-group-gov">
                    <label>Enter Aadhaar Number / Virtual ID | ಆಧಾರ್ ಸಂಖ್ಯೆ / ವರ್ಚುವಲ್ ಐಡಿ ನಮೂದಿಸಿ</label>
                    <input type="password" id="aadhaarInput" placeholder="XXXX XXXX XXXX" maxlength="16">
                    <small class="text-muted">12-digit Aadhaar or 16-digit VID | 12-ಅಂಕಿಯ ಆಧಾರ್ ಅಥವಾ 16-ಅಂಕಿಯ VID</small>
                </div>

                <div class="d-flex gap-3 justify-content-center">
                    <button class="btn-gov-primary" onclick="sendOTP()" id="sendOTPBtn" disabled>
                        Get OTP | OTP ಪಡೆಯಿರಿ
                    </button>
                    <button class="btn-gov-secondary" onclick="cancelTransaction()">
                        Cancel | ರದ್ದುಮಾಡಿ
                    </button>
                </div>
            </div>

            <!-- OTP Section -->
            <div id="otpSection" style="display: none;">
                <div class="alert alert-success">
                    OTP sent to your registered mobile | ನಿಮ್ಮ ನೋಂದಾಯಿತ ಮೊಬೈಲ್‌ಗೆ OTP ಕಳುಹಿಸಲಾಗಿದೆ
                </div>

                <div class="otp-timer" id="otpTimer">03:00</div>

                <div class="input-group-gov">
                    <label>Enter OTP | OTP ನಮೂದಿಸಿ</label>
                    <input type="text" id="otpInput" placeholder="Enter 6-digit OTP" maxlength="6">
                </div>

                <div class="d-flex gap-3 justify-content-center">
                    <button class="btn-gov-primary" onclick="verifyOTP()" id="verifyBtn">
                        Verify & Sign | ಪರಿಶೀಲಿಸಿ ಮತ್ತು ಸಹಿ ಮಾಡಿ
                    </button>
                    <button class="btn-gov-secondary" onclick="resendOTP()" id="resendBtn" disabled>
                        Resend OTP | OTP ಮರುಕಳುಹಿಸಿ
                    </button>
                </div>
            </div>

            <!-- Help Section -->
            <div class="mt-4 text-center">
                <p class="text-muted">
                    <small>
                        Need help? | ಸಹಾಯ ಬೇಕೇ?<br>
                        Call: 080-XXXXXXXX | Email: support@karnataka.gov.in
                    </small>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Google Translate
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'en,kn,hi,ta,te,ml',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE
            }, 'google_translate_element');
        }

        // Global variables
        let requestData = {};
        let timerInterval = null;
        let timeLeft = 180;
        let currentAadhaar = '';

        // Parse request data
        window.onload = function() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const encodedData = urlParams.get('data');
                if (encodedData) {
                    requestData = JSON.parse(atob(encodedData));
                }
                
                setupEventListeners();
            } catch (error) {
                console.error('Error loading request data:', error);
            }
        };

        function setupEventListeners() {
            // Consent checkbox
            document.getElementById('consentCheck').addEventListener('change', function() {
                const sendBtn = document.getElementById('sendOTPBtn');
                sendBtn.disabled = !this.checked || !validateAadhaarSilent();
            });

            // Aadhaar input
            document.getElementById('aadhaarInput').addEventListener('input', function(e) {
                // Format input
                let value = e.target.value.replace(/\s/g, '');
                if (value.length > 0 && value.length % 4 === 0 && value.length < 12) {
                    e.target.value = value.match(/.{1,4}/g).join(' ');
                }
                
                const consentCheck = document.getElementById('consentCheck');
                const sendBtn = document.getElementById('sendOTPBtn');
                sendBtn.disabled = !consentCheck.checked || !validateAadhaarSilent();
            });

            // OTP input
            document.getElementById('otpInput').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });
        }

        function playConsent(language) {
            const audio = document.getElementById('consentAudio');
            audio.style.display = 'block';
            
            // Map language to audio file
            const audioFiles = {
                'kn': '/static/audio/consent_kannada.mp3',
                'en': '/static/audio/consent_english.mp3',
                'hi': '/static/audio/consent_hindi.mp3'
            };
            
            audio.src = audioFiles[language] || audioFiles['en'];
            audio.play();
        }

        function validateAadhaarSilent() {
            const input = document.getElementById('aadhaarInput');
            const value = input.value.replace(/\s/g, '');
            return value.length === 12 || value.length === 16;
        }

        function validateAadhaar() {
            const input = document.getElementById('aadhaarInput');
            const value = input.value.replace(/\s/g, '');
            
            if (!value) {
                alert('Please enter your Aadhaar number or VID\nದಯವಿಟ್ಟು ನಿಮ್ಮ ಆಧಾರ್ ಸಂಖ್ಯೆ ಅಥವಾ VID ನಮೂದಿಸಿ');
                return false;
            }
            
            if (value.length !== 12 && value.length !== 16) {
                alert('Please enter valid 12-digit Aadhaar or 16-digit VID\nದಯವಿಟ್ಟು ಮಾನ್ಯ 12-ಅಂಕಿಯ ಆಧಾರ್ ಅಥವಾ 16-ಅಂಕಿಯ VID ನಮೂದಿಸಿ');
                return false;
            }
            
            return true;
        }

        function sendOTP() {
            if (!validateAadhaar()) return;
            
            currentAadhaar = document.getElementById('aadhaarInput').value.replace(/\s/g, '');
            const sendBtn = document.getElementById('sendOTPBtn');
            
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending... | ಕಳುಹಿಸಲಾಗುತ್ತಿದೆ...';
            
            // Make API call
            fetch('/api/v2/auth/send-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    rid: parseInt(requestData.rid) || 0,
                    uid: currentAadhaar,
                    aspId: 'KARNATAKA-GOV'
                })
            })
            .then(response => response.json())
            .then(data => {
                sendBtn.textContent = 'Get OTP | OTP ಪಡೆಯಿರಿ';
                
                if (data.success) {
                    showOTPSection();
                    startTimer();
                } else {
                    sendBtn.disabled = false;
                    alert('Failed to send OTP. Please try again.\nOTP ಕಳುಹಿಸಲು ವಿಫಲವಾಗಿದೆ. ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                sendBtn.disabled = false;
                sendBtn.textContent = 'Get OTP | OTP ಪಡೆಯಿರಿ';
                alert('Network error. Please try again.\nನೆಟ್‌ವರ್ಕ್ ದೋಷ. ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ.');
            });
        }

        function showOTPSection() {
            document.getElementById('aadhaarSection').style.display = 'none';
            document.getElementById('otpSection').style.display = 'block';
            document.getElementById('otpInput').focus();
        }

        function startTimer() {
            timeLeft = 180;
            updateTimer();
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimer();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('resendBtn').disabled = false;
                    document.getElementById('otpTimer').textContent = 'Expired | ಅವಧಿ ಮುಗಿದಿದೆ';
                }
            }, 1000);
        }

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('otpTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function verifyOTP() {
            const otp = document.getElementById('otpInput').value;
            
            if (otp.length !== 6) {
                alert('Please enter 6-digit OTP\nದಯವಿಟ್ಟು 6-ಅಂಕಿಯ OTP ನಮೂದಿಸಿ');
                return;
            }
            
            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verifying... | ಪರಿಶೀಲಿಸಲಾಗುತ್ತಿದೆ...';
            
            // Make API call
            fetch('/api/v2/auth/verify-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    rid: parseInt(requestData.rid) || 0,
                    uid: currentAadhaar,
                    otp: otp,
                    aspId: 'KARNATAKA-GOV'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    clearInterval(timerInterval);
                    window.location.href = '/esign/success?rid=' + requestData.rid;
                } else {
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = 'Verify & Sign | ಪರಿಶೀಲಿಸಿ ಮತ್ತು ಸಹಿ ಮಾಡಿ';
                    alert('Invalid OTP. Please try again.\nಅಮಾನ್ಯ OTP. ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify & Sign | ಪರಿಶೀಲಿಸಿ ಮತ್ತು ಸಹಿ ಮಾಡಿ';
                alert('Network error. Please try again.\nನೆಟ್‌ವರ್ಕ್ ದೋಷ. ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ.');
            });
        }

        function resendOTP() {
            document.getElementById('resendBtn').disabled = true;
            clearInterval(timerInterval);
            document.getElementById('otpInput').value = '';
            sendOTP();
        }

        function cancelTransaction() {
            if (confirm('Are you sure you want to cancel?\nನೀವು ರದ್ದುಮಾಡಲು ಖಚಿತವಾಗಿದ್ದೀರಾ?')) {
                window.location.href = '/api/v2/cancel?rid=' + (requestData.rid || '') + '&stage=auth';
            }
        }
    </script>
</body>
</html>