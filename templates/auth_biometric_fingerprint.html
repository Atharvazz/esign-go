<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eSign - Biometric Authentication</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .container-custom {
            max-width: 900px;
            margin: 2rem auto;
        }
        .panel-primary {
            border: 1px solid #0d6efd;
            border-radius: 8px;
        }
        .panel-heading {
            background-color: #0d6efd;
            color: white;
            padding: 1rem;
            border-radius: 8px 8px 0 0;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .panel-body {
            padding: 2rem;
        }
        .consent-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .btn-primary {
            background-color: #0d6efd;
            border: none;
            padding: 0.5rem 2rem;
            margin: 0.5rem;
        }
        .btn-secondary {
            background-color: #6c757d;
            border: none;
            padding: 0.5rem 2rem;
            margin: 0.5rem;
        }
        .error-msg {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .success-msg {
            color: #198754;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .device-info {
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .fingerprint-icon {
            width: 64px;
            height: 64px;
            margin: 1rem auto;
            display: block;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            margin: 1rem 0;
        }
        footer {
            background-color: #f8f9fa;
            padding: 1rem;
            text-align: center;
            margin-top: 2rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container container-custom">
        <div class="panel panel-primary">
            <div class="panel-heading">Protean Electronic Signature Service - Biometric Authentication</div>
            <div class="panel-body">
                <!-- Transaction Info -->
                <div class="text-center mb-4">
                    <p><strong>{{.ASPName}}</strong> has requested to Digitally sign the document</p>
                    <p>Transaction ID: <strong>{{.TransactionID}}</strong> dated <strong>{{.Timestamp}}</strong></p>
                </div>

                <!-- Consent Section -->
                <div class="consent-box">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="consentCheck">
                        <label class="form-check-label" for="consentCheck">
                            I hereby authorize Protean eGov Technologies Limited to:
                        </label>
                    </div>
                    <ol>
                        <li>Use my Aadhaar/Virtual ID details for authentication through the Aadhaar Authentication system (Aadhaar based e-KYC services of UIDAI) in accordance with the provisions of the Aadhaar Act, 2016.</li>
                        <li>Authenticate my Aadhaar/Virtual ID through Biometric (Fingerprint) for authenticating my identity through the Aadhaar Authentication system.</li>
                        <li>I understand that the security and confidentiality of personal identity data provided is ensured by Protean eGov Technologies Limited.</li>
                    </ol>
                </div>

                <!-- Aadhaar/VID Input -->
                <div class="row justify-content-center mb-4">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text">VID/Aadhaar:</span>
                            <input type="password" class="form-control" id="aadhaarInput" 
                                   placeholder="Enter VID/Aadhaar" maxlength="16" pattern="\d{12}|\d{16}">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility()">
                                <span id="toggleIcon">üëÅÔ∏è</span>
                            </button>
                        </div>
                        <div id="aadhaarError" class="error-msg"></div>
                    </div>
                </div>

                <!-- Biometric Section -->
                <div class="device-info" id="biometricSection" style="display: none;">
                    <h5 class="text-center mb-3">Fingerprint Authentication</h5>
                    
                    <!-- Fingerprint Icon -->
                    <svg class="fingerprint-icon" viewBox="0 0 24 24">
                        <path fill="#0d6efd" d="M17.81,4.47C17.73,4.47 17.65,4.45 17.58,4.41C15.66,3.42 14,3 12,3C10.03,3 8.15,3.47 6.44,4.41C6.2,4.54 5.9,4.45 5.76,4.21C5.63,3.97 5.72,3.66 5.96,3.53C7.82,2.5 9.86,2 12,2C14.14,2 16,2.47 18.04,3.5C18.29,3.65 18.38,3.95 18.25,4.19C18.16,4.37 18,4.47 17.81,4.47M3.5,9.72C3.4,9.72 3.3,9.69 3.21,9.63C3,9.47 2.93,9.16 3.09,8.93C4.08,7.53 5.34,6.43 6.84,5.66C10,4.04 14,4.03 17.15,5.65C18.65,6.42 19.91,7.5 20.9,8.9C21.06,9.12 21,9.44 20.78,9.6C20.55,9.76 20.24,9.71 20.08,9.5C19.18,8.22 18.04,7.23 16.69,6.54C13.82,5.07 10.15,5.07 7.29,6.55C5.93,7.25 4.79,8.25 3.89,9.5C3.81,9.65 3.66,9.72 3.5,9.72M9.75,21.79C9.62,21.79 9.5,21.74 9.4,21.64C8.53,20.77 8.06,19.58 8.06,18.36C8.06,17.13 8.53,15.95 9.4,15.08C10.27,14.21 11.46,13.74 12.69,13.74C13.91,13.74 15.1,14.21 15.97,15.08C16.84,15.95 17.31,17.13 17.31,18.36C17.31,19.58 16.84,20.77 15.97,21.64C15.72,21.89 15.31,21.89 15.06,21.64C14.81,21.39 14.81,20.98 15.06,20.73C15.71,20.08 16.07,19.23 16.07,18.36C16.07,17.5 15.71,16.64 15.06,16C14.41,15.35 13.56,14.97 12.69,14.97C11.82,14.97 10.97,15.35 10.32,16C9.67,16.64 9.31,17.5 9.31,18.36C9.31,19.23 9.67,20.08 10.32,20.73C10.57,20.98 10.57,21.39 10.32,21.64C10.22,21.74 10.1,21.79 9.75,21.79M16.92,19.94C15.73,19.94 14.68,19.64 13.82,19.05C12.33,18.04 11.44,16.4 11.44,14.66C11.44,11.69 13.69,9.27 16.5,8.96C16.87,8.92 17.21,9.19 17.25,9.56C17.29,9.94 17.03,10.27 16.66,10.31C14.58,10.58 12.94,12.45 12.94,14.66C12.94,16.07 13.65,17.43 14.85,18.3C15.5,18.77 16.26,19 17.13,19C17.5,19 17.83,19.27 17.87,19.64C17.91,20.03 17.65,20.36 17.28,20.4C17.16,20.42 17.04,20.43 16.92,19.94M14.91,22C14.87,22 14.82,22 14.78,22C13.19,21.54 12.15,20.95 11.06,19.88C9.66,18.5 8.89,16.64 8.89,14.66C8.89,11.72 11.13,9.33 14,9C14.38,8.96 14.72,9.24 14.76,9.62C14.8,10 14.53,10.34 14.15,10.38C12.07,10.64 10.44,12.5 10.44,14.66C10.44,16.24 11.07,17.72 12.2,18.81C13.07,19.68 13.89,20.15 15.18,20.54C15.55,20.64 15.77,21.03 15.67,21.4C15.59,21.71 15.3,22 14.91,22M18,21.54C17.94,21.54 17.89,21.53 17.83,21.5C16.27,20.68 15.17,19.19 14.77,17.42C14.73,17.03 15,16.68 15.39,16.64C15.78,16.6 16.13,16.87 16.17,17.26C16.5,18.71 17.37,19.95 18.57,20.66C18.93,20.88 19.03,21.35 18.8,21.7C18.66,21.91 18.43,22 18,21.54Z"/>
                    </svg>

                    <!-- Device Selection -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label>Select Device:</label>
                            <select class="form-select" id="deviceSelect" onchange="onDeviceChange()">
                                <option value="">-- Select Device --</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label>Device Status:</label>
                            <div id="deviceStatus" class="alert alert-info py-1">Not Connected</div>
                        </div>
                    </div>

                    <!-- Capture Button -->
                    <div class="text-center">
                        <button class="btn btn-primary" onclick="captureFingerprint()" id="captureBtn" disabled>
                            Capture Fingerprint
                        </button>
                    </div>

                    <!-- Loading Spinner -->
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Capturing fingerprint...</p>
                    </div>

                    <!-- Status Messages -->
                    <div id="biometricStatus" class="mt-3"></div>
                </div>

                <!-- Action Buttons -->
                <div class="text-center mt-4">
                    <button class="btn btn-primary" onclick="proceedWithBiometric()" id="proceedBtn" disabled>
                        Proceed
                    </button>
                    <button class="btn btn-secondary" onclick="cancelRequest()">
                        Cancel
                    </button>
                </div>

                <!-- Additional Links -->
                <div class="text-center mt-3">
                    <small>
                        <a href="https://resident.uidai.gov.in/vid-generation" target="_blank">Click Here</a> to generate Virtual ID.
                        <a href="#" target="_blank">Download Instructions</a> to generate Virtual ID in lieu of Aadhaar.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <footer>
        Please do not press "Submit" button once again or the "Refresh" or "Back" buttons.
    </footer>

    <script>
        // Global variables
        let requestData = {};
        let deviceInfo = null;
        let capturedBiometric = null;

        // Parse request data from URL or session
        window.onload = function() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const encodedData = urlParams.get('data');
                if (encodedData) {
                    requestData = JSON.parse(atob(encodedData));
                }
                
                // Initialize device discovery
                discoverDevices();
            } catch (error) {
                console.error('Error loading request data:', error);
            }
        };

        // Toggle password visibility
        function togglePasswordVisibility() {
            const input = document.getElementById('aadhaarInput');
            const icon = document.getElementById('toggleIcon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.textContent = 'üôà';
            } else {
                input.type = 'password';
                icon.textContent = 'üëÅÔ∏è';
            }
        }

        // Validate Aadhaar/VID
        function validateAadhaar() {
            const input = document.getElementById('aadhaarInput');
            const errorDiv = document.getElementById('aadhaarError');
            const value = input.value.replace(/\s/g, '');
            
            if (!value) {
                errorDiv.textContent = 'Please enter Aadhaar/VID';
                return false;
            }
            
            if (value.length !== 12 && value.length !== 16) {
                errorDiv.textContent = 'Enter valid 12-digit Aadhaar or 16-digit VID';
                return false;
            }
            
            if (!/^\d+$/.test(value)) {
                errorDiv.textContent = 'Only digits are allowed';
                return false;
            }
            
            errorDiv.textContent = '';
            return true;
        }

        // Check consent and show biometric section
        document.getElementById('consentCheck').addEventListener('change', function() {
            const biometricSection = document.getElementById('biometricSection');
            const proceedBtn = document.getElementById('proceedBtn');
            
            if (this.checked && validateAadhaar()) {
                biometricSection.style.display = 'block';
                checkProceedEnabled();
            } else {
                biometricSection.style.display = 'none';
                proceedBtn.disabled = true;
            }
        });

        document.getElementById('aadhaarInput').addEventListener('input', function() {
            const consentCheck = document.getElementById('consentCheck');
            if (consentCheck.checked) {
                const biometricSection = document.getElementById('biometricSection');
                if (validateAadhaar()) {
                    biometricSection.style.display = 'block';
                } else {
                    biometricSection.style.display = 'none';
                }
            }
            checkProceedEnabled();
        });

        // Device discovery (mock for now - real implementation would use RD service)
        function discoverDevices() {
            // In real implementation, this would call the RD service discovery endpoint
            // For now, we'll mock it
            setTimeout(() => {
                const deviceSelect = document.getElementById('deviceSelect');
                deviceSelect.innerHTML = `
                    <option value="">-- Select Device --</option>
                    <option value="mock-device-1">Mock Fingerprint Scanner 1</option>
                    <option value="mock-device-2">Mock Fingerprint Scanner 2</option>
                `;
            }, 1000);
        }

        // Handle device selection
        function onDeviceChange() {
            const deviceSelect = document.getElementById('deviceSelect');
            const deviceStatus = document.getElementById('deviceStatus');
            const captureBtn = document.getElementById('captureBtn');
            
            if (deviceSelect.value) {
                deviceStatus.textContent = 'Connected';
                deviceStatus.className = 'alert alert-success py-1';
                captureBtn.disabled = false;
                deviceInfo = { id: deviceSelect.value, name: deviceSelect.options[deviceSelect.selectedIndex].text };
            } else {
                deviceStatus.textContent = 'Not Connected';
                deviceStatus.className = 'alert alert-info py-1';
                captureBtn.disabled = true;
                deviceInfo = null;
            }
            checkProceedEnabled();
        }

        // Capture fingerprint
        function captureFingerprint() {
            const loadingSpinner = document.getElementById('loadingSpinner');
            const biometricStatus = document.getElementById('biometricStatus');
            const captureBtn = document.getElementById('captureBtn');
            
            loadingSpinner.style.display = 'block';
            captureBtn.disabled = true;
            
            // Mock fingerprint capture - in real implementation, this would call RD service
            setTimeout(() => {
                loadingSpinner.style.display = 'none';
                captureBtn.disabled = false;
                
                // Mock captured data
                capturedBiometric = {
                    deviceId: deviceInfo.id,
                    timestamp: new Date().toISOString(),
                    quality: 85,
                    data: 'mock-fingerprint-data-base64'
                };
                
                biometricStatus.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Fingerprint captured successfully!</strong><br>
                        Quality Score: ${capturedBiometric.quality}%
                    </div>
                `;
                
                checkProceedEnabled();
            }, 2000);
        }

        // Check if proceed button should be enabled
        function checkProceedEnabled() {
            const consentCheck = document.getElementById('consentCheck');
            const proceedBtn = document.getElementById('proceedBtn');
            
            proceedBtn.disabled = !(
                consentCheck.checked &&
                validateAadhaar() &&
                deviceInfo &&
                capturedBiometric
            );
        }

        // Proceed with biometric authentication
        function proceedWithBiometric() {
            if (!validateAadhaar() || !capturedBiometric) {
                alert('Please complete all required steps');
                return;
            }
            
            const aadhaar = document.getElementById('aadhaarInput').value.replace(/\s/g, '');
            
            // Prepare authentication request
            const authRequest = {
                rid: requestData.rid || '',
                uid: aadhaar,
                authType: 'BIOMETRIC_FP',
                biometricData: capturedBiometric,
                deviceInfo: deviceInfo
            };
            
            // Submit authentication request
            fetch('/api/v2/auth/biometric', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(authRequest)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '/esign/success?rid=' + requestData.rid;
                } else {
                    alert('Authentication failed: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during authentication');
            });
        }

        // Cancel request
        function cancelRequest() {
            if (confirm('Are you sure you want to cancel this request?')) {
                const rid = requestData.rid || '';
                window.location.href = '/api/v2/cancel?rid=' + rid + '&stage=biometric';
            }
        }
    </script>
</body>
</html>